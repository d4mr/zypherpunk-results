---
import { getImage } from 'astro:assets';
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Hero } from '../components/Hero';
import { ProjectGrid } from '../components/ProjectGrid';
import { getAllProjects, getMeta, type ProjectWithAwards } from '../lib/awards';
import { fetchProjects, extractSlugFromUrl, getImageUrl, type Project } from '../lib/devfolio';

// Get all award data
const allAwards = getAllProjects();
const meta = getMeta();

// Extract slugs and fetch all projects at build time
const slugs = allAwards
  .map(award => extractSlugFromUrl(award.url))
  .filter((slug): slug is string => slug !== null);

const projectsMap = await fetchProjects(slugs);

// Combine award data with Devfolio data
const projectsWithDevfolio: Array<{ devfolio: Project; awards: ProjectWithAwards }> = [];

for (const award of allAwards) {
  const slug = extractSlugFromUrl(award.url);
  if (!slug) continue;
  
  const devfolioData = projectsMap.get(slug);
  if (devfolioData) {
    projectsWithDevfolio.push({
      devfolio: devfolioData,
      awards: award,
    });
  }
}

// Sort by total USD descending (default)
projectsWithDevfolio.sort((a, b) => (b.awards.totalUSD || 0) - (a.awards.totalUSD || 0));

// Pre-optimize images at build time
async function optimizeImage(url: string | null, width: number, height: number): Promise<string | null> {
  if (!url) return null;
  const fullUrl = getImageUrl(url);
  if (!fullUrl) return null;
  
  const img = await getImage({
    src: fullUrl,
    width,
    height,
    format: 'webp',
  });
  return img.src;
}

const optimizedProjects = await Promise.all(
  projectsWithDevfolio.map(async ({ devfolio, awards }) => {
    // Optimize cover and favicon
    const [optimizedCover, optimizedFavicon] = await Promise.all([
      optimizeImage(devfolio._cover_img, 400, 225),
      optimizeImage(devfolio._favicon, 80, 80),
    ]);
    
    // Optimize builder avatars
    const optimizedBuilders = await Promise.all(
      (devfolio.builders || []).map(async (builder) => ({
        ...builder,
        _optimizedAvatar: await optimizeImage(builder._profile_image, 48, 48),
      }))
    );
    
    return {
      devfolio: {
        ...devfolio,
        _optimizedCover: optimizedCover,
        _optimizedFavicon: optimizedFavicon,
        builders: optimizedBuilders,
      },
      awards,
    };
  })
);
---

<Layout title="Zypherpunk Hackathon Winners">
  <Header />
  
  <main>
    <Hero 
      client:load
      totalProjects={meta.totalProjects}
      totalAwards={meta.totalAwards}
      totalUSD={meta.totalUSD}
    />
    
    <section class="mx-auto max-w-7xl px-6 py-16">
      <div class="mb-8">
        <h2 class="font-display text-2xl text-white">
          Winning Projects
        </h2>
      </div>
      
      <ProjectGrid client:load projects={optimizedProjects} />
    </section>
  </main>
  
  <Footer />
</Layout>

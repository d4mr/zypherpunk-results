---
import { getImage } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { TrackProjectGrid } from '../../components/TrackProjectGrid';
import { getAllTracksFromProjects, getProjectsByTrack, type ProjectAward, type ProjectWithAwards } from '../../lib/awards';
import { getSponsorsForTrack, type Sponsor, type SponsorBounty } from '../../lib/sponsors';
import { fetchProjects, extractSlugFromUrl, getImageUrl, type Project } from '../../lib/devfolio';
import type { SearchableProject } from '../../lib/search';

export async function getStaticPaths() {
  const slugify = (track: string): string => {
    return track
      .toLowerCase()
      .replace(/[&]/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-|-$/g, "");
  };

  const tracks = getAllTracksFromProjects();
  
  return tracks.map(track => ({
    params: { slug: slugify(track) },
    props: { track, trackSlug: slugify(track) }
  }));
}

interface Props {
  track: string;
  trackSlug: string;
}

const { track, trackSlug } = Astro.props;

// Get projects that won in this track
const winningProjectsData = getProjectsByTrack(track);

// Get sponsors that have bounties for this track
const sponsorsWithBounties = getSponsorsForTrack(track);

// Fetch Devfolio data for all winning projects
const slugs = winningProjectsData
  .map(({ project }) => extractSlugFromUrl(project.url))
  .filter((slug): slug is string => slug !== null);

const devfolioMap = await fetchProjects(slugs);

// Optimize images
async function optimizeImage(url: string | null, width: number, height: number): Promise<string | null> {
  if (!url) return null;
  const fullUrl = getImageUrl(url);
  if (!fullUrl) return null;
  
  try {
    const img = await getImage({ src: fullUrl, width, height, format: 'webp' });
    return img.src;
  } catch {
    return fullUrl;
  }
}

// Build SearchableProject objects with optimized images
const searchableProjects: Array<SearchableProject & { trackAwards: ProjectAward[] }> = await Promise.all(
  winningProjectsData.map(async ({ project, awards }) => {
    const slug = extractSlugFromUrl(project.url);
    const devfolio = slug ? devfolioMap.get(slug) : null;
    
    if (!devfolio) {
      return {
        slug: slug || project.url,
        name: project.name,
        tagline: "",
        builderNames: [],
        builderUsernames: [],
        hashtags: [],
        sponsors: awards.map(a => a.sponsor),
        tracks: awards.map(a => a.track).filter(Boolean) as string[],
        totalUSD: project.totalUSD,
        awardCount: project.awards.length,
        devfolio: {
          name: project.name,
          slug: slug || "",
          tagline: null,
          description: null,
          _cover_img: null,
          _favicon: null,
          _optimizedCover: null,
          _optimizedFavicon: null,
          video_url: null,
          demo_url: null,
          source_code_url: null,
          links: null,
          pictures: null,
          created_at: "",
          builders: [],
          hashtags: [],
        } as Project,
        awards: project,
        trackAwards: awards,
      };
    }
    
    // Optimize images
    const [optimizedCover, optimizedFavicon] = await Promise.all([
      optimizeImage(devfolio._cover_img, 400, 225),
      optimizeImage(devfolio._favicon, 80, 80),
    ]);
    
    // Optimize builder avatars
    const optimizedBuilders = await Promise.all(
      (devfolio.builders || []).map(async (builder) => ({
        ...builder,
        _optimizedAvatar: await optimizeImage(builder._profile_image, 48, 48),
      }))
    );
    
    const enrichedDevfolio: Project = {
      ...devfolio,
      _optimizedCover: optimizedCover,
      _optimizedFavicon: optimizedFavicon,
      builders: optimizedBuilders,
    };
    
    return {
      slug: devfolio.slug,
      name: devfolio.name,
      tagline: devfolio.tagline || "",
      builderNames: devfolio.builders?.map(b => `${b.first_name || ""} ${b.last_name || ""}`.trim()).filter(Boolean) || [],
      builderUsernames: devfolio.builders?.map(b => b.username) || [],
      hashtags: devfolio.hashtags?.map(h => h.hashtag.name) || [],
      sponsors: [...new Set(project.awards.map(a => a.sponsor))],
      tracks: [...new Set(project.awards.map(a => a.track).filter(Boolean) as string[])],
      totalUSD: project.totalUSD,
      awardCount: project.awards.length,
      devfolio: enrichedDevfolio,
      awards: project,
      trackAwards: awards,
    };
  })
);

// Calculate total prize pool for this track
const totalPrizePool = sponsorsWithBounties.reduce((sum, { bounty }) => {
  const match = bounty.amount.match(/\$?([\d,]+)/);
  if (match && !bounty.amount.includes("NIL") && !bounty.amount.includes("credits") && !bounty.amount.includes("ZEC")) {
    return sum + parseInt(match[1].replace(/,/g, ""));
  }
  return sum;
}, 0);

// Calculate total awarded in this track
const totalAwarded = winningProjectsData.reduce((sum, { awards }) => {
  return sum + awards.reduce((aSum, a) => {
    const match = a.amount.match(/\$?([\d,]+)/);
    if (match && !a.amount.includes("NIL") && !a.amount.includes("credits") && !a.amount.includes("ZEC")) {
      return aSum + parseInt(match[1].replace(/,/g, ""));
    }
    return aSum;
  }, 0);
}, 0);

// Track colors
const trackColors: Record<string, string> = {
  "Cross-Chain Privacy Solutions": "emerald",
  "Privacy-Preserving AI & Computation": "violet",
  "Private Payments & Transactions": "amber",
  "Privacy Infrastructure & Developer Tools": "sky",
  "Self-Custody & Wallet Innovation": "rose",
  "Private DeFi & Trading": "orange",
  "Zcash Data & Analytics": "cyan",
  "Privacy-Focused Content & Media": "pink",
  "Creative Privacy Applications": "indigo",
};

const trackColor = trackColors[track] || "gray";
---

<Layout title={`${track} - Zypherpunk Track`} description={`Winning projects in the ${track} track at Zypherpunk Hackathon`} image={`/og/track/${trackSlug}.png`}>
  <Header />
  
  <main class="mx-auto max-w-7xl px-5 py-8 sm:px-6 sm:py-12">
    <!-- Back link -->
    <a
      href="/"
      class="mb-6 inline-flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-white"
    >
      <svg class="h-4 w-4" viewBox="0 0 16 16" fill="none">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      Back to projects
    </a>

    <!-- Track Header -->
    <div class="mb-10">
      <div class="flex flex-wrap items-start justify-between gap-6">
        <div>
          <div class="mb-2 text-sm font-medium uppercase tracking-wider text-accent">
            Track
          </div>
          <h1 class="font-display text-3xl text-white sm:text-4xl">
            {track}
          </h1>
        </div>

        <div class="flex gap-4">
          {totalPrizePool > 0 && (
            <div class="rounded-lg border border-gray-800 bg-gray-900/50 px-4 py-3 text-center">
              <div class="text-xs text-muted-foreground">Prize Pool</div>
              <div class="font-mono text-lg font-bold text-accent">
                ${totalPrizePool.toLocaleString()}
              </div>
            </div>
          )}
          {searchableProjects.length > 0 && (
            <div class="rounded-lg border border-gold/30 bg-gold/5 px-4 py-3 text-center">
              <div class="text-xs text-gold/70">Awarded</div>
              <div class="font-mono text-lg font-bold text-gold">
                ${totalAwarded.toLocaleString()}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Sponsors for this track -->
    {sponsorsWithBounties.length > 0 && (
      <section class="mb-10">
        <h2 class="mb-4 font-display text-lg text-white">Sponsors</h2>
        <div class="flex flex-wrap gap-3">
          {sponsorsWithBounties.map(({ sponsor, bounty }) => (
            <a
              href={`/sponsor/${sponsor.id}`}
              class="group flex items-center gap-3 rounded-lg border border-gray-800 bg-gray-900/50 px-4 py-2.5 transition-colors hover:border-gray-700"
            >
              {sponsor.logo ? (
                <img 
                  src={sponsor.logo} 
                  alt={sponsor.displayName}
                  class="h-8 w-8 rounded bg-gray-800 object-contain p-1"
                  loading="lazy"
                />
              ) : (
                <div class="flex h-8 w-8 items-center justify-center rounded bg-gray-800 text-sm font-bold text-gray-400 group-hover:text-white">
                  {sponsor.displayName.charAt(0)}
                </div>
              )}
              <div>
                <div class="text-sm font-medium text-white">{sponsor.displayName}</div>
                <div class="font-mono text-xs text-accent">{bounty.amount}</div>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Winning Projects -->
    {searchableProjects.length > 0 ? (
      <TrackProjectGrid 
        client:load
        projects={searchableProjects}
        trackColor={trackColor}
      />
    ) : (
      <div class="rounded-xl border border-gray-800 bg-gray-900/30 px-6 py-12 text-center">
        <p class="text-muted-foreground">No winning projects recorded for this track yet.</p>
      </div>
    )}
  </main>
  
  <Footer />
</Layout>
